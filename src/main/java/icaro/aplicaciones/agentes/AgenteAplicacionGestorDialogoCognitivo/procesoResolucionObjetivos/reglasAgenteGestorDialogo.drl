import icaro.infraestructura.recursosOrganizacion.recursoTrazas.ItfUsoRecursoTrazas;
import icaro.infraestructura.recursosOrganizacion.recursoTrazas.imp.componentes.InfoTraza;
import icaro.infraestructura.entidadesBasicas.procesadorCognitivo.*;
import icaro.infraestructura.entidadesBasicas.informes.*;
import icaro.infraestructura.patronAgenteCognitivo.procesadorObjetivos.gestorTareas.ItfGestorTareas;
import icaro.infraestructura.entidadesBasicas.PerformativaUsuario;
import icaro.infraestructura.entidadesBasicas.interfaces.InterfazUsoAgente;
import icaro.infraestructura.entidadesBasicas.comunicacion.MensajeSimple;
import icaro.aplicaciones.agentes.AgenteAplicacionGestorDialogoCognitivo.objetivos.*;
import icaro.aplicaciones.agentes.AgenteAplicacionGestorDialogoCognitivo.tareas.*;
import icaro.aplicaciones.informacion.dominioRecipe2Me.*;
import icaro.aplicaciones.informacion.dominioRecipe2Me.eventos.*;

global ItfGestorTareas gestorTareas;
global ItfUsoRecursoTrazas recursoTrazas;
global String agentId;

rule "Creacion de los objectivos iniciales"
when 
	not(Focus())
then 
	TareaSincrona tarea = gestorTareas.crearTareaSincrona(InicializarInfoWorkMem.class);
    tarea.ejecutar();
	recursoTrazas.aceptaNuevaTrazaEjecReglas(agentId," EJECUTO LA REGLA: " + drools.getRule().getName()); 
end

/////////////////////////////////////////////////////////////////////////////////////////////////
///Reglas de Focalizacion
rule "Focaliza el objetivo ObtenerInfoSesion"
  when
    obj:ObtenerInfoSesion();
    f:Focus(foco == null )
  then
    f.setFoco(obj);
    recursoTrazas.aceptaNuevaTrazaEjecReglas(agentId," EJECUTO LA REGLA: " + drools.getRule().getName());
    update(f);
end
//=======================================================================
///Reglas de Consecucion del Objetivo ObtenerInfoSesion
rule "Inicio del proceso de consecucion del  objetivo ObtenerInfoSesion"
  when
    obj:ObtenerInfoSesion(state==Objetivo.PENDING)
    evento:EventoConexion( name : user.username )
    Focus(foco == obj)
  then
    obj.setSolving();
    update(obj);
end

rule "Creacion de la sesion del usuario"
   when
    obj:ObtenerInfoSesion(state==Objetivo.SOLVING)
    obj2:ObtenerIngredientesFavoritos(state==Objetivo.PENDING)
    evento:EventoConexion( name : user.username )
    f:Focus(foco == obj)
   then
    recursoTrazas.aceptaNuevaTraza(new InfoTraza(agentId,"Se ejecuta la tarea : RegistrarDialogoUsuario",InfoTraza.NivelTraza.debug));
    TareaSincrona tarea = gestorTareas.crearTareaSincrona(RegistrarDialogoUsuario.class);
    tarea.ejecutar(evento);
    recursoTrazas.aceptaNuevaTraza(new InfoTraza(agentId,"Realizando el objetivo : "+obj.getgoalId()+"  Ejecutando la tarea : "+ tarea.getIdentTarea() ,InfoTraza.NivelTraza.debug));
    recursoTrazas.aceptaNuevaTrazaEjecReglas(agentId," EJECUTO LA REGLA: " + drools.getRule().getName());
    f.setFoco(obj2);
    update(f);
end

rule "Inicio del proceso de obtencion de ingredientes favoritos"
  when
    obj:ObtenerIngredientesFavoritos(state==Objetivo.PENDING)
    Focus(foco == obj)
  then
    obj.setSolving();
    update(obj);
end

rule "Obtener ingredientes favoritos"
   when
    obj:ObtenerIngredientesFavoritos(state==Objetivo.SOLVING)
    evento:EventoMensajeDelUsuario()
    f:Focus(foco == obj)
   then
    recursoTrazas.aceptaNuevaTraza(new InfoTraza(agentId,"Se ejecuta la tarea : RegistrarDialogoUsuario",InfoTraza.NivelTraza.debug));
    TareaSincrona tarea = gestorTareas.crearTareaSincrona(TareaObtenerIngredientesFavoritos.class);
    tarea.ejecutar(evento);
    retract(evento);
end

rule "Zanjar objetivo ObtenerIngredientesFavoritos"
   when
     obj:ObtenerIngredientesFavoritos(state==Objetivo.SOLVING)
     informe:InformeDeTarea(identTarea == "TareaObtenerIngredientesFavoritos")
     f:Focus(foco == obj)
   then
     obj.setSolved();
     update(obj);   
 end

rule "Inicio del proceso de obtencion de ingredientes odiados"
  when
    obj:ObtenerIngredientesFavoritos(state==Objetivo.SOLVED)
    obj2:ObtenerIngredientesOdiados(state==Objetivo.PENDING)
    f:Focus(foco == obj)
  then
    f.setFoco(obj2);
    update(f);
    obj2.setSolving();
    update(obj2);
end

rule "Obtener ingredientes odiados"
   when
    obj:ObtenerIngredientesOdiados(state==Objetivo.SOLVING)
    evento:EventoMensajeDelUsuario()
    f:Focus(foco == obj)
   then
    recursoTrazas.aceptaNuevaTraza(new InfoTraza(agentId,"Se ejecuta la tarea : RegistrarDialogoUsuario",InfoTraza.NivelTraza.debug));
    TareaSincrona tarea = gestorTareas.crearTareaSincrona(TareaObtenerIngredientesOdiados.class);
    tarea.ejecutar(evento);
    retract(evento);

end

rule "Zanjar objetivo ObtenerIngredientesOdiados"
   when
     obj:ObtenerIngredientesOdiados(state==Objetivo.SOLVING)
     informe:InformeDeTarea(identTarea == "TareaObtenerIngredientesOdiados")
     f:Focus(foco == obj)
   then
     obj.setSolved();
     update(obj);   
 end
 
 rule "Inicio del proceso de obtencion de alergias"
  when
    obj:ObtenerIngredientesOdiados(state==Objetivo.SOLVED)
    obj2:ObtenerAlergia(state==Objetivo.PENDING)
    f:Focus(foco == obj)
  then
    f.setFoco(obj2);
    update(f);
    obj2.setSolving();
    update(obj2);
end


rule "Obtener alergias"
   when
    obj:ObtenerAlergia(state==Objetivo.SOLVING)
    evento:EventoMensajeDelUsuario()
    f:Focus(foco == obj)
   then
    recursoTrazas.aceptaNuevaTraza(new InfoTraza(agentId,"Se ejecuta la tarea : RegistrarDialogoUsuario",InfoTraza.NivelTraza.debug));
    TareaSincrona tarea = gestorTareas.crearTareaSincrona(TareaObtenerAlergia.class);
    tarea.ejecutar(evento);
    retract(evento);

end


rule "Zanjar objetivo ObtenerAlergia"
   when
     obj:ObtenerAlergia(state==Objetivo.SOLVING)
     informe:InformeDeTarea(identTarea == "TareaObtenerAlergia")
     f:Focus(foco == obj)
   then
     obj.setSolved();
     update(obj);   
 end





